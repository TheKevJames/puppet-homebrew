language: ruby
rvm:
  - 1.9.3
  # - 2.2.3  # TODO: figure out why this fails

env: TRAVIS_DEFAULT_JOBS_SUCK="true"

os: osx
matrix:
  include:
    - osx_image: beta-xcode6.1  # 10.9
      env: PUPPET_VERSION="~> 3.0"
    - osx_image: beta-xcode6.1  # 10.9
      env: PUPPET_VERSION="~> 3.0" FUTURE_PARSER="yes"
    - osx_image: beta-xcode6.1  # 10.9
      env: PUPPET_VERSION="~> 4.0"
  exclude:
    - env: TRAVIS_DEFAULT_JOBS_SUCK="true"

cache: bundler
bundler_args: --without system_tests

install:
  - brew update >/dev/null
  - brew cask update >/dev/null

  - sudo bundle install

  - sudo bundle exec puppet module build
  - sudo bundle exec puppet module install pkg/thekevjames-homebrew-*.tar.gz

before_script:
  - sudo chown -R travis:admin /usr/local
  - sudo chmod -R 0775 /usr/local

script:
  - sudo STRICT_VARIABLES="yes" bundle exec rake validate

  - sudo FUTURE_PARSER="$FUTURE_PARSER" bundle exec puppet apply --detailed-exitcodes tests/init.pp || [ $? -eq 2 ]
  - which brew

  - sudo FUTURE_PARSER="$FUTURE_PARSER" bundle exec puppet apply --detailed-exitcodes --debug tests/install_options.pp || [ $? -eq 2 ]
  - which ack

  - sudo FUTURE_PARSER="$FUTURE_PARSER" bundle exec puppet apply --detailed-exitcodes --debug tests/packages.pp || [ $? -eq 2 ]
  - which clementine
  - which git
  - which google-chrome
  - which tmux

  - sudo FUTURE_PARSER="$FUTURE_PARSER" bundle exec puppet apply --detailed-exitcodes --debug tests/tap.pp || [ $? -eq 2 ]
  - which gc2qif

  - sudo FUTURE_PARSER="$FUTURE_PARSER" bundle exec puppet apply --detailed-exitcodes --debug tests/tap_priority.pp || [ $? -eq 2 ]
  - which nvim

notifications:
  email: false
