version: 2

jobs:
  lint:
    docker:
      - image: python:3.6.4
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: pip install pre-commit
      - restore_cache:
          keys:
            - cache-pre-commit-{{ checksum ".pre-commit-config.yaml" }}
      - run: pre-commit run --all-files
      - save_cache:
          key: cache-pre-commit-{{ checksum ".pre-commit-config.yaml" }}
          paths:
            - ~/.cache/pre-commit

  build-ruby-1.9.3-puppet-3:
    docker:
      - image: aptible/ruby:1.9.3
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<4.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-1.9.3-puppet-4:
    docker:
      - image: aptible/ruby:1.9.3
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<5.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-1.9.3-puppet-5:
    docker:
      - image: aptible/ruby:1.9.3
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<6.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.2.10-puppet-3:
    docker:
      - image: ruby:2.2.10
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<4.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.2.10-puppet-4:
    docker:
      - image: ruby:2.2.10
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<5.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.2.10-puppet-5:
    docker:
      - image: ruby:2.2.10
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<6.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.3.7-puppet-3:
    docker:
      - image: ruby:2.3.7
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<4.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.3.7-puppet-4:
    docker:
      - image: ruby:2.3.7
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<5.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.3.7-puppet-5:
    docker:
      - image: ruby:2.3.7
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<6.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.4.4-puppet-3:
    docker:
      - image: ruby:2.4.4
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<4.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.4.4-puppet-4:
    docker:
      - image: ruby:2.4.4
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<5.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.4.4-puppet-5:
    docker:
      - image: ruby:2.4.4
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<6.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.5.1-puppet-3:
    docker:
      - image: ruby:2.5.1
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<4.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.5.1-puppet-4:
    docker:
      - image: ruby:2.5.1
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<5.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  build-ruby-2.5.1-puppet-5:
    docker:
      - image: ruby:2.5.1
    environment:
      STRICT_VARIABLES: "yes"
    steps:
      - checkout
      - run: gem install puppet-lint "puppet:<6.0.0"
      - run:
          name: lint
          command: |
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/init.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/install.pp
            puppet-lint --no-documentation-check --no-autoloader_layout-check --no-80chars-check manifests/compiler.pp
            puppet parser validate --noop manifests/init.pp
            puppet parser validate --noop manifests/install.pp
            puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

workflows:
  version: 2
  run-jobs:
    jobs:
      - lint
      - build-ruby-1.9.3-puppet-3
      - build-ruby-1.9.3-puppet-4
      - build-ruby-1.9.3-puppet-5
      - build-ruby-2.2.10-puppet-3
      - build-ruby-2.2.10-puppet-4
      - build-ruby-2.2.10-puppet-5
      - build-ruby-2.3.7-puppet-3
      - build-ruby-2.3.7-puppet-4
      - build-ruby-2.3.7-puppet-5
      - build-ruby-2.4.4-puppet-3
      - build-ruby-2.4.4-puppet-4
      - build-ruby-2.4.4-puppet-5
      - build-ruby-2.5.1-puppet-3
      - build-ruby-2.5.1-puppet-4
      - build-ruby-2.5.1-puppet-5
