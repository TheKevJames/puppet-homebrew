version: 2.1

orbs:
  linter: thekevjames/linter@0

jobs:
  test-pup4:
    docker:
      - image: ruby:<< parameters.ruby_version >>
    environment:
      STRICT_VARIABLES: "yes"
    parameters:
      ruby_version:
        type: string
    steps:
      - checkout
      - run: gem install --no-ri --no-rdoc puppet-lint "puppet:<5.0.0"
      - run: puppet-lint manifests/init.pp
      - run: puppet-lint manifests/install.pp
      - run: puppet-lint manifests/compiler.pp
      - run: puppet parser validate --noop manifests/init.pp
      - run: puppet parser validate --noop manifests/install.pp
      - run: puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  test-pup5:
    docker:
      - image: ruby:<< parameters.ruby_version >>
    environment:
      STRICT_VARIABLES: "yes"
    parameters:
      ruby_version:
        type: string
    steps:
      - checkout
      - run: gem install --no-ri --no-rdoc puppet-lint "puppet:<6.0.0"
      - run: puppet-lint manifests/init.pp
      - run: puppet-lint manifests/install.pp
      - run: puppet-lint manifests/compiler.pp
      - run: puppet parser validate --noop manifests/init.pp
      - run: puppet parser validate --noop manifests/install.pp
      - run: puppet parser validate --noop manifests/compiler.pp
      - run: puppet module build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

  test-pup6:
    docker:
      - image: ruby:<< parameters.ruby_version >>
    environment:
      STRICT_VARIABLES: "yes"
    parameters:
      ruby_version:
        type: string
    steps:
      - checkout
      - run: gem install --no-ri --no-rdoc pdk puppet-lint "puppet:<7.0.0"
      - run: puppet-lint manifests/init.pp
      - run: puppet-lint manifests/install.pp
      - run: puppet-lint manifests/compiler.pp
      - run: puppet parser validate --noop manifests/init.pp
      - run: puppet parser validate --noop manifests/install.pp
      - run: puppet parser validate --noop manifests/compiler.pp
      - run: pdk build
      - run: puppet module install pkg/thekevjames-homebrew-*.tar.gz
      # - run: ./test.sh

workflows:
  version: 2
  run-jobs:
    jobs:
      - linter/pre-commit:
          python_version: 3.7.10
          pre-steps:
            - run: apt-get update
            - run: apt-get install -qy shellcheck

      - test-pup4:
          name: test-pup4-ruby<<matrix.ruby_version>>
          matrix:
            parameters:
              ruby_version:
                - '2.2.10'
                - '2.3.7'
                - '2.4.4'
                - '2.5.1'
      - test-pup5:
          name: test-pup5-ruby<<matrix.ruby_version>>
          matrix:
            parameters:
              ruby_version:
                - '2.2.10'
                - '2.3.7'
                - '2.4.4'
                - '2.5.1'
      - test-pup6:
          name: test-pup6-ruby<<matrix.ruby_version>>
          matrix:
            parameters:
              ruby_version:
                - '2.5.1'
